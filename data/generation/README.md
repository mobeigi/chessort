# Chessort - Data Generation

## Overview

This is a helper script designed to pre-generate Chessort games from FEN strings using the Stockfish engine. It retrieves the top N moves, filters out positions that do not meet a minimum number of distinct move evaluations, and saves the results to CSV files along with metadata.

## Folder Structure

- **out/**: This folder contains the output files generated by the script. Each output file represents a chunk of processed data along with its corresponding metadata file. Move files from this folder into `chunks` when they are ready to be used for the game.
- **chunks/**: This folder is for pre-processed chunks of data that are ready for further use or integration into a database.
- **lichess-data/**: This folder holds the CSV files from the Lichess Open Database project ([Lichess Puzzles](https://database.lichess.org/#puzzles)). The actual raw files are too large and are not included directly here. The input file must be named `lichess_db_puzzle.csv`.

## Script

### generate.py

The `generate.py` script processes chess positions from the Lichess puzzle CSV file using the Stockfish engine. See the header inside the file for more information.

#### Functionality

- Analyzes chess positions from FEN strings using Stockfish.
- Retrieves the top N moves for each position.
- Filters out positions that do not meet a minimum number of distinct move evaluations.
- Saves the results to CSV files.
- Generates metadata for each chunk of processed data.

#### How to Run

1. **Setup Stockfish**: Download and install Stockfish from the [Stockfish website](https://stockfishchess.org/download/). Ensure the Stockfish engine path is correctly set in the `STOCKFISH_PATH` environment variable.
2. **Prepare Input Data**: Place the Lichess puzzle CSV file in the `lichess-data/` folder. The input file must be named `lichess_db_puzzle.csv`.
3. **Run the Script**:
    ```sh
    python generate.py
    ```

#### Output

- **CSV Files**: The processed data is saved in the `out/` folder as CSV files with the format `chessort-{offset}-{limit}.csv`.
- **Metadata Files**: Each CSV file is accompanied by a metadata JSON file with the same prefix, containing details about the processing parameters and file hashes.

## Example

After running the script, you might see the following files in the `out/` folder:

- `chessort-100000-5.csv`
- `chessort-100000-5.metadata.json`

These files represent a chunk of 5 processed lines starting from the offset of 100,000 in the Lichess puzzle CSV file, along with their processing metadata.

### Example Files

#### chessort-100000-5.csv
```csv
LichessPuzzleId,FEN,Rating,Moves
1XySo,8/8/R1p2P2/2k1P3/2P5/8/p3K3/7r w - - 1 47,879,"f6f7 +527, e5e6 +457, a6a5 +437, a6a2 -532, e2d3 -533, a6a4 -536, e2d2 -536, a6a3 -544, e2e3 -592, e2f3 -602"
1XyUE,2k3r1/ppp5/4pPq1/Pb1pBn2/3P3p/2P2Q1P/2P2PP1/R4RK1 w - - 3 23,1655,"c3c4 +396, f1e1 +394, g2g4 +389, a1e1 +371, g2g3 +368, f3g4 +350, f6f7 +290, g1h2 -25, g1h1 -39, a5a6 -247"
1XyRa,2kr3r/pp4p1/2pb2p1/4qp2/3p2P1/3Q3P/PP2PBB1/R2R2K1 w - - 0 21,2161,"d3d4 +340, d3f3 +290, g4f5 +281, g4g5 +277, a1c1 +252, a2a4 +247, a1b1 +234, d3c4 +231, g1f1 +223, a2a3 +201"
1XyTH,r2q1rk1/1b2b1pp/3p4/p2npp2/PP6/4BP2/NP1QB1PP/R4RK1 b - - 0 20,1469,"d5e3 +165, g8h8 +141, a8c8 +83, f5f4 +16, d5b4 -46, d5f6 -84, d5f4 -90, d5c7 -105, f8f7 -145, d5b6 -236"
1XyRx,r1bqk2r/ppp2ppp/2nbp3/3pN3/3PnB2/2P1P2P/PP3PP1/RN1QKB1R b KQkq - 2 7,1390,"d6e5 +9, c6e5 -7, d8f6 -9, d8h4 -19, c8d7 -21, a7a5 -23, e8g8 -32, c6e7 -32, d8e7 -36, h7h6 -38"
```

#### chessort-100000-5.metadata.json
```json
{
    "stockfishVersion": "16.1",
    "offset": 100000,
    "limit": 5,
    "evaluationDepth": 22,
    "multipv": 10,
    "minimumDistinctMoveBuckets": 8,
    "inputLichessFileSha256": "a480b5c25389d653800889bcf223d32a622249bd3d6ba3e210b8c75bc8092300",
    "outputFileSha256": "db30fcec7a15277dfa365bdb5ee6dd068f328fdcc151783771dc08109c8c3919"
}
```
